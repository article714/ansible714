- name: Configure and deploy dockerized apps
  hosts: DockerNodes
  remote_user: root
  become: true

  tasks:
    - name: Pull API Docker image
      docker_image:
        name: '{{ DOCKER_REGISTRY }}/{{ item.image_name }}'
        source: pull
        force: yes
        state: present
      with_items: '{{ DOCKERIZED_APPS }}'

    - name: Deploy containers
      docker_container:
        name: '{{ item.name}}'
        image: '{{ DOCKER_REGISTRY }}/{{ item.image_name }}'
        volumes: '{{ item.volumes }}'
        networks:
          - name: '{{ item.container_network }}'
            ipv4_address: '{{ item.container_ip }}'
        state: started
        restart_policy: always
        recreate: yes
      with_items: '{{ DOCKERIZED_APPS }}'
