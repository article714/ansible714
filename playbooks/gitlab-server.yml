- name: Manage LXD-Nodes
  hosts: LXDNodes
  remote_user: root
  become: true
  gather_facts: yes

  tasks:
    - name: LXD Node
      include_role:
        name: lxd-node
      when: machine_type == 'host'

  tags:
    - host_config

- name: Set sysctl to workarround gitlab issue
  hosts: devserv1
  remote_user: root
  become: true

  tasks:
    - name: workarround sysctl issue (1)
      sysctl:
        name: kernel.shmall
        value: 4194304
        state: present

    - name: workarround sysctl issue (2)
      sysctl:
        name: kernel.shmmax
        value: 17179869184
        state: present

- name: Deploy gitlab server into lxc container
  hosts: GitlabNodes
  remote_user: root
  become: true
  gather_facts: no

  pre_tasks:
    - setup:
      when: machine_type == "host"

  roles:
    - gitlab-server

  tags:
    - gitlab_config